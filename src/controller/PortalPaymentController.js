const _0x2773db=_0x1f74;(function(_0x5e1dd9,_0x5e6dad){const _0x137e48=_0x1f74,_0x2487b5=_0x5e1dd9();while(!![]){try{const _0xb2972d=parseInt(_0x137e48(0x167))/0x1*(parseInt(_0x137e48(0x15d))/0x2)+-parseInt(_0x137e48(0x132))/0x3+-parseInt(_0x137e48(0x16e))/0x4+parseInt(_0x137e48(0x13b))/0x5+-parseInt(_0x137e48(0x147))/0x6*(-parseInt(_0x137e48(0x14f))/0x7)+parseInt(_0x137e48(0x156))/0x8*(parseInt(_0x137e48(0x149))/0x9)+-parseInt(_0x137e48(0x166))/0xa*(parseInt(_0x137e48(0x14e))/0xb);if(_0xb2972d===_0x5e6dad)break;else _0x2487b5['push'](_0x2487b5['shift']());}catch(_0x297ff0){_0x2487b5['push'](_0x2487b5['shift']());}}}(_0x9411,0x46e06));const {runQuery}=require(_0x2773db(0x13e)),{sendMail}=require(_0x2773db(0x15b)),axios=require(_0x2773db(0x15c)),notifier=require('node-notifier'),dotenv=require('dotenv'),credentials=dotenv[_0x2773db(0x150)]({'path':'.env.credentials.focaltec'}),database=[],tenantIds=[],apiKeys=[],apiSecrets=[],url=credentials[_0x2773db(0x148)]['URL'],tenantIdValues=credentials['parsed'][_0x2773db(0x151)][_0x2773db(0x12e)](','),apiKeyValues=credentials[_0x2773db(0x148)][_0x2773db(0x165)][_0x2773db(0x12e)](','),apiSecretValues=credentials[_0x2773db(0x148)][_0x2773db(0x140)]['split'](','),databaseValues=credentials[_0x2773db(0x148)]['DATABASES'][_0x2773db(0x12e)](',');tenantIds[_0x2773db(0x138)](...tenantIdValues),apiKeys['push'](...apiKeyValues),apiSecrets[_0x2773db(0x138)](...apiSecretValues),database[_0x2773db(0x138)](...databaseValues);function _0x1f74(_0x33fc39,_0x53f113){const _0x941156=_0x9411();return _0x1f74=function(_0x1f742d,_0x3a4418){_0x1f742d=_0x1f742d-0x12e;let _0x4b2ab3=_0x941156[_0x1f742d];return _0x4b2ab3;},_0x1f74(_0x33fc39,_0x53f113);}function _0x9411(){const _0x56fa64=['splice','2175870uhBFiE','post','/public/img/cerrar.png','../utils/SQLServerConnection','invoice_currency','API_SECRET','AsientoPago','slice','provider_external_id','NoPagoSage','\x20con\x20el\x20NoPagoSage\x20','No\x20hay\x20facturas\x20pagadas\x20para\x20subir\x20a\x20portal','1627062sqtHYf','parsed','27vIxzGo','Se\x20inserto\x20correctamente\x20el\x20pago\x20en\x20la\x20tabla\x20fesaPagosFocaltec','\x27,\x20\x27','status','Alta\x20de\x20pagos\x20en\x20portal','11uFdfyW','14RoUYsx','config','TENANT_ID','invoice_exchange_rate','LotePago','bank_account_id','toISOString','63136jnyxYr','Error\x20al\x20ejecutar\x20el\x20proceso\x20de\x20alta\x20de\x20pagos\x20en\x20portal','cwd','length','SELECT\x20DP.CNTBTCH\x20as\x20LotePago,DP.CNTRMIT\x20as\x20AsientoPago,\x20\x20RTRIM(DP.IDVEND)\x20as\x20IDVEND,\x20RTRIM(DP.IDINVC)\x20AS\x20IDINVC,\x20H.AMTGROSDST\x20AS\x20invoice_amount,\x20DP.DOCTYPE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20,\x20CASE\x20H.CODECURN\x20WHEN\x20\x27MXP\x27\x20THEN\x20\x27MXN\x27\x20ELSE\x20H.CODECURN\x20END\x20AS\x20invoice_currency\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20,\x20H.EXCHRATEHC\x20\x20AS\x20invoice_exchange_rate\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20,\x20DP.AMTPAYM\x20\x20AS\x20payment_amount\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20,\x20ISNULL((SELECT\x20RTRIM([VALUE])\x20FROM\x20APIBHO\x20\x20WHERE\x20CNTBTCH\x20=\x20H.CNTBTCH\x20\x20AND\x20CNTITEM\x20=\x20H.CNTITEM\x20AND\x20OPTFIELD\x20=\x20\x27FOLIOCFD\x27),\x27\x27)\x20AS\x20UUID\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x20APTCP\x20DP\x20,\x20APIBH\x20H,\x20APIBC\x20C\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x20DP.BATCHTYPE\x20=\x27PY\x27\x20AND\x20DP.CNTBTCH=\x20','../utils/EmailSender','axios','12jSnztS','SELECT\x20NoPagoSage\x20FROM\x20fesa.dbo.fesaPagosFocaltec','external_id','total_amount','operation_type','Se\x20ejecuto\x20correctamente\x20el\x20proceso\x20de\x20alta\x20de\x20pagos\x20en\x20portal,\x20para\x20la\x20compañia\x20','replace','/payments','API_KEY','1277810ElQZUz','61224ZjmFoF','No\x20hay\x20pagos\x20para\x20subir\x20a\x20portal','No\x20se\x20ejecuto\x20el\x20proceso\x20de\x20alta\x20de\x20pagos\x20en\x20portal,\x20para\x20la\x20compañia\x20','payment_date','notify','data','bk_currency','1888632AHAEWB','No\x20se\x20ejecuto\x20el\x20proceso:\x20','split','\x20AND\x20DP.CNTRMIT\x20=\x20','UUID','No\x20se\x20pudo\x20insertar\x20el\x20pago\x20en\x20portal','1434897MNPyvi','Se\x20ejecuto\x20el\x20proceso\x20de\x20alta\x20de\x20pagos\x20en\x20portal,\x20para\x20la\x20compañia\x20','catch','recordset','exports','reference','push','log'];_0x9411=function(){return _0x56fa64;};return _0x9411();}async function uploadPayments(_0x1b8114){const _0x49899f=_0x2773db;try{const _0x43c9aa=new Date()[_0x49899f(0x155)]()[_0x49899f(0x142)](0x0,0xa)[_0x49899f(0x163)](/-/g,''),_0x253cc6='SELECT\x20P.CNTBTCH\x20as\x20LotePago,\x20P.CNTENTR\x20as\x20AsientoPago,\x20RTRIM(BK.ADDR1)\x20AS\x20bank_account_id,\x20B.IDBANK,\x20P.DATEBUS\x20as\x20FechaAsentamiento\x0a\x20\x20\x20\x20\x20\x20\x20\x20,\x20P.DOCNBR\x20as\x20external_id,P.TEXTRMIT\x20AS\x20comments,\x20P.TXTRMITREF\x20AS\x20reference\x0a\x20\x20\x20\x20\x20\x20\x20\x20,\x20CASE\x20BK.CURNSTMT\x20WHEN\x20\x27MXP\x27\x20THEN\x20\x27MXN\x27\x20ELSE\x20BK.CURNSTMT\x20END\x20AS\x20bk_currency\x0a\x20\x20\x20\x20\x20\x20\x20\x20,P.DATERMIT\x20as\x20payment_date,\x20RTRIM(P.IDVEND)\x20as\x20provider_external_id\x0a\x20\x20\x20\x20\x20\x20\x20\x20,\x20P.AMTRMIT\x20as\x20total_amount\x0a\x20\x20\x20\x20\x20\x20\x20\x20,\x20\x27TRANSFER\x27\x20as\x20operation_type\x0a\x20\x20\x20\x20\x20\x20\x20\x20,\x20P.RATEEXCHHC\x20as\x20TipoCambioPago\x0a\x20\x20\x20\x20\x20\x20\x20\x20,\x20ISNULL((SELECT\x20[VALUE]\x20FROM\x20APVENO\x20WHERE\x20OPTFIELD\x20=\x27RFC\x27\x20AND\x20VENDORID\x20=\x20P.IDVEND\x20),\x27\x27)\x20AS\x20RFC\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x20APBTA\x20B,\x20BKACCT\x20BK,\x20APTCR\x20P\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x20B.IDBANK\x20=\x20BK.BANK\x20\x20AND\x20B.PAYMTYPE\x20=\x20P.BTCHTYPE\x20AND\x20B.CNTBTCH\x20=\x20P.CNTBTCH\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20P.ERRENTRY\x20=\x200\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20B.PAYMTYPE=\x27PY\x27\x20AND\x20B.BATCHSTAT\x20=\x203\x20AND\x20P.DATEBUS>='+_0x43c9aa+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20P.DOCNBR\x20NOT\x20IN\x20(SELECT\x20NoPagoSage\x20FROM\x20fesa.dbo.fesaPagosFocaltec\x20WHERE\x20idCia\x20=\x20P.AUDTORG\x20AND\x20\x20NoPagoSage\x20=\x20P.DOCNBR\x20)\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20P.DOCNBR\x20NOT\x20IN\x20(SELECT\x20IDINVC\x20FROM\x20APPYM\x20WHERE\x20IDBANK\x20=\x20B.IDBANK\x20AND\x20CNTBTCH\x20=\x20P.CNTBTCH\x20AND\x20CNTITEM\x20=P.CNTENTR\x20AND\x20SWCHKCLRD\x20=\x202\x20)',_0x29758d=await runQuery(_0x253cc6,database[_0x1b8114])[_0x49899f(0x134)](_0x4b7791=>{const _0x4deda0=_0x49899f;return console[_0x4deda0(0x139)](_0x4b7791),{'recordset':[]};}),_0x576938=_0x49899f(0x15e),_0x27f070=await runQuery(_0x576938)[_0x49899f(0x134)](_0x588aff=>{return console['log'](_0x588aff),{'recordset':[]};});if(_0x27f070[_0x49899f(0x135)][_0x49899f(0x159)]>0x0)for(let _0x5b7d68=0x0;_0x5b7d68<_0x27f070[_0x49899f(0x135)][_0x49899f(0x159)];_0x5b7d68++){for(let _0x160bb7=0x0;_0x160bb7<_0x29758d[_0x49899f(0x135)][_0x49899f(0x159)];_0x160bb7++){_0x27f070[_0x49899f(0x135)][_0x5b7d68][_0x49899f(0x144)]===_0x29758d[_0x49899f(0x135)][_0x160bb7][_0x49899f(0x15f)]&&_0x29758d[_0x49899f(0x135)][_0x49899f(0x13a)](_0x160bb7,0x1);}}if(_0x29758d['recordset'][_0x49899f(0x159)]>0x0)for(let _0x4fb3e8=0x0;_0x4fb3e8<_0x29758d[_0x49899f(0x135)][_0x49899f(0x159)];_0x4fb3e8++){const _0x29854b=[],_0x2adcb2=_0x49899f(0x15a)+_0x29758d['recordset'][_0x4fb3e8][_0x49899f(0x153)]+_0x49899f(0x12f)+_0x29758d[_0x49899f(0x135)][_0x4fb3e8][_0x49899f(0x141)]+'\x20AND\x20DP.DOCTYPE\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20H.ORIGCOMP=\x27\x27\x20AND\x20DP.IDVEND\x20=\x20H.IDVEND\x20\x20AND\x20DP.IDINVC\x20=\x20H.IDINVC\x20\x20AND\x20H.ERRENTRY\x20=\x200\x20AND\x20H.CNTBTCH\x20=\x20C.CNTBTCH\x20AND\x20C.BTCHSTTS\x20=\x203',_0x3905b3=await runQuery(_0x2adcb2,database[_0x1b8114])[_0x49899f(0x134)](_0x3d3400=>{return console['log'](_0x3d3400),{'recordset':[]};});if(_0x3905b3[_0x49899f(0x135)][_0x49899f(0x159)]>0x0){for(let _0x27389a=0x0;_0x27389a<_0x3905b3['recordset']['length'];_0x27389a++){const _0x544ee5={'amount':_0x3905b3[_0x49899f(0x135)][_0x27389a]['payment_amount'],'currency':_0x3905b3[_0x49899f(0x135)][_0x27389a][_0x49899f(0x13f)],'exchange_rate':_0x3905b3[_0x49899f(0x135)][_0x27389a][_0x49899f(0x152)],'payment_amount':_0x3905b3[_0x49899f(0x135)][_0x27389a]['payment_amount'],'payment_currency':_0x29758d[_0x49899f(0x135)][_0x4fb3e8][_0x49899f(0x16d)],'uuid':_0x3905b3[_0x49899f(0x135)][_0x27389a][_0x49899f(0x130)]};_0x29854b[_0x49899f(0x138)](_0x544ee5);}const _0x28e77f=_0x29758d[_0x49899f(0x135)][_0x4fb3e8][_0x49899f(0x16a)]['toString'](),_0x45a94f=_0x28e77f[_0x49899f(0x142)](0x0,0x4)+'-'+_0x28e77f['slice'](0x4,0x6)+'-'+_0x28e77f[_0x49899f(0x142)](0x6,0x8)+'T10:00:00.000Z',_0x1cc1ff={'bank_account_id':_0x29758d[_0x49899f(0x135)][_0x4fb3e8][_0x49899f(0x154)],'cfdis':_0x29854b,'comments':_0x29758d['recordset'][_0x4fb3e8]['comments'],'currency':_0x29758d['recordset'][_0x4fb3e8][_0x49899f(0x16d)],'external_id':_0x29758d[_0x49899f(0x135)][_0x4fb3e8][_0x49899f(0x15f)],'ignore_amounts':![],'mark_existing_cfdi_as_payed':!![],'open':![],'operation_type':_0x29758d['recordset'][_0x4fb3e8][_0x49899f(0x161)],'payment_date':_0x45a94f,'provider_external_id':_0x29758d['recordset'][_0x4fb3e8][_0x49899f(0x143)],'reference':_0x29758d[_0x49899f(0x135)][_0x4fb3e8][_0x49899f(0x137)],'total_amount':_0x29758d['recordset'][_0x4fb3e8][_0x49899f(0x160)]},_0x4bf219=await axios[_0x49899f(0x13c)](url+'/api/1.0/extern/tenants/'+tenantIds[_0x1b8114]+_0x49899f(0x164),_0x1cc1ff,{'headers':{'PDPTenantKey':apiKeys[_0x1b8114],'PDPTenantSecret':apiSecrets[_0x1b8114]}})[_0x49899f(0x134)](_0x5555e1=>{return{'status':0x1f4,'data':_0x5555e1};});if(_0x4bf219[_0x49899f(0x14c)]===0xc8){const _0x239dd4=_0x49899f(0x162)+database[_0x1b8114]+_0x49899f(0x145)+_0x29758d[_0x49899f(0x135)][_0x4fb3e8][_0x49899f(0x15f)],_0x2e3003={'h1':_0x49899f(0x14d),'p':_0x49899f(0x133)+database[_0x1b8114]+_0x49899f(0x145)+_0x29758d[_0x49899f(0x135)][_0x4fb3e8][_0x49899f(0x15f)],'status':_0x4bf219[_0x49899f(0x14c)],'message':_0x239dd4,'position':_0x1b8114,'idCia':database[_0x1b8114]};await sendMail(_0x2e3003)[_0x49899f(0x134)](_0x5839c1=>{const _0x52e764=_0x49899f;console[_0x52e764(0x139)](_0x5839c1);});const _0x89fb56='INSERT\x20INTO\x20fesa.dbo.fesaPagosFocaltec\x20(idCia,\x20NoPagoSage)\x20VALUES\x20(\x27'+database[_0x1b8114]+_0x49899f(0x14b)+_0x29758d[_0x49899f(0x135)][_0x4fb3e8][_0x49899f(0x15f)]+'\x27)',_0x546a45=await runQuery(_0x89fb56)[_0x49899f(0x134)](_0x4a08cd=>{const _0x4be4e2=_0x49899f;return console[_0x4be4e2(0x139)](_0x4a08cd),{'rowsAffected':[0x0]};});_0x546a45['rowsAffected'][0x0]>0x0?console[_0x49899f(0x139)](_0x49899f(0x14a)):console[_0x49899f(0x139)]('No\x20se\x20inserto\x20el\x20pago\x20en\x20la\x20tabla\x20fesaPagosFocaltec');}else{console['log'](_0x49899f(0x131));const _0x38c67f={'h1':_0x49899f(0x14d),'p':_0x49899f(0x169)+database[_0x1b8114]+_0x49899f(0x145)+_0x29758d['recordset'][_0x4fb3e8]['external_id'],'status':_0x4bf219['status'],'message':_0x4bf219[_0x49899f(0x16c)],'position':_0x1b8114,'idCia':database[_0x1b8114]};await sendMail(_0x38c67f)[_0x49899f(0x134)](_0x5de993=>{const _0x4bd26c=_0x49899f;console[_0x4bd26c(0x139)](_0x5de993);});try{notifier[_0x49899f(0x16b)]({'title':'Error\x20al\x20ejecutar\x20el\x20proceso\x20de\x20alta\x20de\x20pagos\x20en\x20portal','message':_0x49899f(0x16f)+_0x4bf219['data'],'sound':!![],'wait':!![],'icon':process[_0x49899f(0x158)]()+_0x49899f(0x13d)});}catch(_0x30fcf4){console[_0x49899f(0x139)](_0x30fcf4),console['log'](_0x49899f(0x16f)+_0x4bf219[_0x49899f(0x16c)]);}}}else console[_0x49899f(0x139)](_0x49899f(0x146));}else console[_0x49899f(0x139)](_0x49899f(0x168));}catch(_0x4c70f2){try{notifier[_0x49899f(0x16b)]({'title':_0x49899f(0x157),'message':_0x49899f(0x16f)+_0x4c70f2,'sound':!![],'wait':!![],'icon':process[_0x49899f(0x158)]()+_0x49899f(0x13d)});}catch(_0x315088){console[_0x49899f(0x139)](_0x315088);}}}module[_0x2773db(0x136)]={'uploadPayments':uploadPayments};
