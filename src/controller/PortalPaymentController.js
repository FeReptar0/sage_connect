const _0x534a33=_0x3c57;(function(_0x32a2c1,_0x3aa3f7){const _0x5aa5c5=_0x3c57,_0x4cd143=_0x32a2c1();while(!![]){try{const _0x51674c=parseInt(_0x5aa5c5(0x1c6))/0x1+-parseInt(_0x5aa5c5(0x1ce))/0x2*(parseInt(_0x5aa5c5(0x1bf))/0x3)+parseInt(_0x5aa5c5(0x1ad))/0x4+parseInt(_0x5aa5c5(0x1cb))/0x5+-parseInt(_0x5aa5c5(0x1b5))/0x6*(-parseInt(_0x5aa5c5(0x1a5))/0x7)+parseInt(_0x5aa5c5(0x1aa))/0x8+-parseInt(_0x5aa5c5(0x1bd))/0x9;if(_0x51674c===_0x3aa3f7)break;else _0x4cd143['push'](_0x4cd143['shift']());}catch(_0x110877){_0x4cd143['push'](_0x4cd143['shift']());}}}(_0x3919,0xcc4f1));function _0x3c57(_0x46505b,_0x40132d){const _0x3919ef=_0x3919();return _0x3c57=function(_0x3c57f0,_0x22a016){_0x3c57f0=_0x3c57f0-0x198;let _0x44b15a=_0x3919ef[_0x3c57f0];return _0x44b15a;},_0x3c57(_0x46505b,_0x40132d);}function _0x3919(){const _0x3fe4e2=['push','/api/1.0/extern/tenants/','toString','Alta\x20de\x20pagos\x20en\x20portal','exports','length','16610985WZNnZP','\x20AND\x20DP.CNTRMIT\x20=\x20','12ofnrgr','\x27,\x20\x27','operation_type','/payments','No\x20hay\x20pagos\x20para\x20subir\x20a\x20portal','total_amount','axios','35077mqZMog','LotePago','Error\x20al\x20ejecutar\x20el\x20proceso\x20de\x20alta\x20de\x20pagos\x20en\x20portal','Se\x20ejecuto\x20correctamente\x20el\x20proceso\x20de\x20alta\x20de\x20pagos\x20en\x20portal,\x20para\x20la\x20compañia\x20','toISOString','337195tPgPXL','AsientoPago','SELECT\x20NoPagoSage\x20FROM\x20fesa.dbo.fesaPagosFocaltec','206838osLufM','\x20AND\x20DP.DOCTYPE\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20H.ORIGCOMP=\x27\x27\x20AND\x20DP.IDVEND\x20=\x20H.IDVEND\x20\x20AND\x20DP.IDINVC\x20=\x20H.IDINVC\x20\x20AND\x20H.ERRENTRY\x20=\x200\x20AND\x20H.CNTBTCH\x20=\x20C.CNTBTCH\x20AND\x20C.BTCHSTTS\x20=\x203','status','/public/img/cerrar.png','node-notifier','NoPagoSage','config','split','cwd','API_KEY','external_id','No\x20se\x20inserto\x20el\x20pago\x20en\x20la\x20tabla\x20fesaPagosFocaltec','notify','log','reference','INSERT\x20INTO\x20fesa.dbo.fesaPagosFocaltec\x20(idCia,\x20NoPagoSage)\x20VALUES\x20(\x27','../utils/EmailSender','URL','No\x20se\x20pudo\x20insertar\x20el\x20pago\x20en\x20portal','data','provider_external_id','TENANT_ID','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20P.DOCNBR\x20NOT\x20IN\x20(SELECT\x20NoPagoSage\x20FROM\x20fesa.dbo.fesaPagosFocaltec\x20WHERE\x20idCia\x20=\x20P.AUDTORG\x20AND\x20\x20NoPagoSage\x20=\x20P.DOCNBR\x20)\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20P.DOCNBR\x20NOT\x20IN\x20(SELECT\x20IDINVC\x20FROM\x20APPYM\x20WHERE\x20IDBANK\x20=\x20B.IDBANK\x20AND\x20CNTBTCH\x20=\x20P.CNTBTCH\x20AND\x20CNTITEM\x20=P.CNTENTR\x20AND\x20SWCHKCLRD\x20=\x202\x20)','bk_currency','catch','\x20con\x20el\x20NoPagoSage\x20','812WjsnMj','No\x20se\x20ejecuto\x20el\x20proceso:\x20','payment_date','invoice_exchange_rate','splice','12327704FnGhWs','post','UUID','4535308FYeBZr','../utils/SQLServerConnection','recordset','.env.credentials.focaltec','parsed','payment_amount','slice','Se\x20inserto\x20correctamente\x20el\x20pago\x20en\x20la\x20tabla\x20fesaPagosFocaltec','16494qMEnMn','invoice_currency'];_0x3919=function(){return _0x3fe4e2;};return _0x3919();}const {runQuery}=require(_0x534a33(0x1ae)),{sendMail}=require(_0x534a33(0x19b)),axios=require(_0x534a33(0x1c5)),notifier=require(_0x534a33(0x1d2)),dotenv=require('dotenv'),credentials=dotenv[_0x534a33(0x1d4)]({'path':_0x534a33(0x1b0)}),database=[],tenantIds=[],apiKeys=[],apiSecrets=[],url=credentials['parsed'][_0x534a33(0x19c)],tenantIdValues=credentials[_0x534a33(0x1b1)][_0x534a33(0x1a0)][_0x534a33(0x1d5)](','),apiKeyValues=credentials[_0x534a33(0x1b1)][_0x534a33(0x1d7)]['split'](','),apiSecretValues=credentials[_0x534a33(0x1b1)]['API_SECRET'][_0x534a33(0x1d5)](','),databaseValues=credentials['parsed']['DATABASES']['split'](',');tenantIds[_0x534a33(0x1b7)](...tenantIdValues),apiKeys[_0x534a33(0x1b7)](...apiKeyValues),apiSecrets['push'](...apiSecretValues),database['push'](...databaseValues);async function uploadPayments(_0x23e66c){const _0x459681=_0x534a33;try{const _0x5976fd=new Date()[_0x459681(0x1ca)]()[_0x459681(0x1b3)](0x0,0xa)['replace'](/-/g,''),_0x1990d5='SELECT\x20P.CNTBTCH\x20as\x20LotePago,\x20P.CNTENTR\x20as\x20AsientoPago,\x20RTRIM(BK.ADDR1)\x20AS\x20bank_account_id,\x20B.IDBANK,\x20P.DATEBUS\x20as\x20FechaAsentamiento\x0a\x20\x20\x20\x20\x20\x20\x20\x20,\x20P.DOCNBR\x20as\x20external_id,P.TEXTRMIT\x20AS\x20comments,\x20P.TXTRMITREF\x20AS\x20reference\x0a\x20\x20\x20\x20\x20\x20\x20\x20,\x20CASE\x20BK.CURNSTMT\x20WHEN\x20\x27MXP\x27\x20THEN\x20\x27MXN\x27\x20ELSE\x20BK.CURNSTMT\x20END\x20AS\x20bk_currency\x0a\x20\x20\x20\x20\x20\x20\x20\x20,P.DATERMIT\x20as\x20payment_date,\x20RTRIM(P.IDVEND)\x20as\x20provider_external_id\x0a\x20\x20\x20\x20\x20\x20\x20\x20,\x20P.AMTRMIT\x20as\x20total_amount\x0a\x20\x20\x20\x20\x20\x20\x20\x20,\x20\x27TRANSFER\x27\x20as\x20operation_type\x0a\x20\x20\x20\x20\x20\x20\x20\x20,\x20P.RATEEXCHHC\x20as\x20TipoCambioPago\x0a\x20\x20\x20\x20\x20\x20\x20\x20,\x20ISNULL((SELECT\x20[VALUE]\x20FROM\x20APVENO\x20WHERE\x20OPTFIELD\x20=\x27RFC\x27\x20AND\x20VENDORID\x20=\x20P.IDVEND\x20),\x27\x27)\x20AS\x20RFC\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x20APBTA\x20B,\x20BKACCT\x20BK,\x20APTCR\x20P\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x20B.IDBANK\x20=\x20BK.BANK\x20\x20AND\x20B.PAYMTYPE\x20=\x20P.BTCHTYPE\x20AND\x20B.CNTBTCH\x20=\x20P.CNTBTCH\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20P.ERRENTRY\x20=\x200\x20AND\x20P.RMITTYPE\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20B.PAYMTYPE=\x27PY\x27\x20AND\x20B.BATCHSTAT\x20=\x203\x20AND\x20P.DATEBUS>='+_0x5976fd+_0x459681(0x1a1),_0x3a48cd=await runQuery(_0x1990d5,database[_0x23e66c])[_0x459681(0x1a3)](_0x4c3e8d=>{return console['log'](_0x4c3e8d),{'recordset':[]};}),_0x11442a=_0x459681(0x1cd),_0x34dd47=await runQuery(_0x11442a)['catch'](_0x80a1a1=>{const _0x22aa98=_0x459681;return console[_0x22aa98(0x198)](_0x80a1a1),{'recordset':[]};});if(_0x34dd47[_0x459681(0x1af)][_0x459681(0x1bc)]>0x0)for(let _0x20c6e2=0x0;_0x20c6e2<_0x34dd47[_0x459681(0x1af)][_0x459681(0x1bc)];_0x20c6e2++){for(let _0x1bdbc3=0x0;_0x1bdbc3<_0x3a48cd['recordset'][_0x459681(0x1bc)];_0x1bdbc3++){_0x34dd47[_0x459681(0x1af)][_0x20c6e2][_0x459681(0x1d3)]===_0x3a48cd[_0x459681(0x1af)][_0x1bdbc3][_0x459681(0x1d8)]&&_0x3a48cd[_0x459681(0x1af)][_0x459681(0x1a9)](_0x1bdbc3,0x1);}}if(_0x3a48cd[_0x459681(0x1af)][_0x459681(0x1bc)]>0x0)for(let _0x78250f=0x0;_0x78250f<_0x3a48cd[_0x459681(0x1af)][_0x459681(0x1bc)];_0x78250f++){const _0x5f94cc=[],_0x1bb70e='SELECT\x20DP.CNTBTCH\x20as\x20LotePago,DP.CNTRMIT\x20as\x20AsientoPago,\x20\x20RTRIM(DP.IDVEND)\x20as\x20IDVEND,\x20RTRIM(DP.IDINVC)\x20AS\x20IDINVC,\x20H.AMTGROSDST\x20AS\x20invoice_amount,\x20DP.DOCTYPE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20,\x20CASE\x20H.CODECURN\x20WHEN\x20\x27MXP\x27\x20THEN\x20\x27MXN\x27\x20ELSE\x20H.CODECURN\x20END\x20AS\x20invoice_currency\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20,\x20H.EXCHRATEHC\x20\x20AS\x20invoice_exchange_rate\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20,\x20DP.AMTPAYM\x20\x20AS\x20payment_amount\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20,\x20ISNULL((SELECT\x20RTRIM([VALUE])\x20FROM\x20APIBHO\x20\x20WHERE\x20CNTBTCH\x20=\x20H.CNTBTCH\x20\x20AND\x20CNTITEM\x20=\x20H.CNTITEM\x20AND\x20OPTFIELD\x20=\x20\x27FOLIOCFD\x27),\x27\x27)\x20AS\x20UUID\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x20APTCP\x20DP\x20,\x20APIBH\x20H,\x20APIBC\x20C\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x20DP.BATCHTYPE\x20=\x27PY\x27\x20AND\x20DP.CNTBTCH=\x20'+_0x3a48cd[_0x459681(0x1af)][_0x78250f][_0x459681(0x1c7)]+_0x459681(0x1be)+_0x3a48cd[_0x459681(0x1af)][_0x78250f][_0x459681(0x1cc)]+_0x459681(0x1cf),_0x361844=await runQuery(_0x1bb70e,database[_0x23e66c])['catch'](_0x439576=>{const _0x6dc0bc=_0x459681;return console[_0x6dc0bc(0x198)](_0x439576),{'recordset':[]};});if(_0x361844[_0x459681(0x1af)][_0x459681(0x1bc)]>0x0){for(let _0x42d710=0x0;_0x42d710<_0x361844[_0x459681(0x1af)][_0x459681(0x1bc)];_0x42d710++){const _0x8ff999={'amount':_0x361844['recordset'][_0x42d710][_0x459681(0x1b2)],'currency':_0x361844['recordset'][_0x42d710][_0x459681(0x1b6)],'exchange_rate':_0x361844['recordset'][_0x42d710][_0x459681(0x1a8)],'payment_amount':_0x361844[_0x459681(0x1af)][_0x42d710]['payment_amount'],'payment_currency':_0x3a48cd['recordset'][_0x78250f][_0x459681(0x1a2)],'uuid':_0x361844[_0x459681(0x1af)][_0x42d710][_0x459681(0x1ac)]};_0x5f94cc[_0x459681(0x1b7)](_0x8ff999);}const _0x4fafbd=_0x3a48cd[_0x459681(0x1af)][_0x78250f][_0x459681(0x1a7)][_0x459681(0x1b9)](),_0x5d3ad3=_0x4fafbd[_0x459681(0x1b3)](0x0,0x4)+'-'+_0x4fafbd[_0x459681(0x1b3)](0x4,0x6)+'-'+_0x4fafbd[_0x459681(0x1b3)](0x6,0x8)+'T10:00:00.000Z',_0x165b32={'bank_account_id':_0x3a48cd[_0x459681(0x1af)][_0x78250f]['bank_account_id'],'cfdis':_0x5f94cc,'comments':_0x3a48cd[_0x459681(0x1af)][_0x78250f]['comments'],'currency':_0x3a48cd[_0x459681(0x1af)][_0x78250f][_0x459681(0x1a2)],'external_id':_0x3a48cd[_0x459681(0x1af)][_0x78250f][_0x459681(0x1d8)],'ignore_amounts':![],'mark_existing_cfdi_as_payed':!![],'open':![],'operation_type':_0x3a48cd['recordset'][_0x78250f][_0x459681(0x1c1)],'payment_date':_0x5d3ad3,'provider_external_id':_0x3a48cd[_0x459681(0x1af)][_0x78250f][_0x459681(0x19f)],'reference':_0x3a48cd[_0x459681(0x1af)][_0x78250f][_0x459681(0x199)],'total_amount':_0x3a48cd[_0x459681(0x1af)][_0x78250f][_0x459681(0x1c4)]},_0x22585b=await axios[_0x459681(0x1ab)](url+_0x459681(0x1b8)+tenantIds[_0x23e66c]+_0x459681(0x1c2),_0x165b32,{'headers':{'PDPTenantKey':apiKeys[_0x23e66c],'PDPTenantSecret':apiSecrets[_0x23e66c]}})[_0x459681(0x1a3)](_0x4d0ab3=>{return{'status':0x1f4,'data':_0x4d0ab3};});if(_0x22585b[_0x459681(0x1d0)]===0xc8){const _0x411211=_0x459681(0x1c9)+database[_0x23e66c]+'\x20con\x20el\x20NoPagoSage\x20'+_0x3a48cd[_0x459681(0x1af)][_0x78250f][_0x459681(0x1d8)],_0x4e5646={'h1':_0x459681(0x1ba),'p':'Se\x20ejecuto\x20el\x20proceso\x20de\x20alta\x20de\x20pagos\x20en\x20portal,\x20para\x20la\x20compañia\x20'+database[_0x23e66c]+'\x20con\x20el\x20NoPagoSage\x20'+_0x3a48cd['recordset'][_0x78250f][_0x459681(0x1d8)],'status':_0x22585b['status'],'message':_0x411211,'position':_0x23e66c,'idCia':database[_0x23e66c]};await sendMail(_0x4e5646)[_0x459681(0x1a3)](_0x31ae54=>{const _0x626107=_0x459681;console[_0x626107(0x198)](_0x31ae54);});const _0x132689=_0x459681(0x19a)+database[_0x23e66c]+_0x459681(0x1c0)+_0x3a48cd[_0x459681(0x1af)][_0x78250f][_0x459681(0x1d8)]+'\x27)',_0x4c156c=await runQuery(_0x132689)['catch'](_0x2e3005=>{const _0xda9e2=_0x459681;return console[_0xda9e2(0x198)](_0x2e3005),{'rowsAffected':[0x0]};});_0x4c156c['rowsAffected'][0x0]>0x0?console[_0x459681(0x198)](_0x459681(0x1b4)):console[_0x459681(0x198)](_0x459681(0x1d9));}else{console[_0x459681(0x198)](_0x459681(0x19d));const _0x27163d={'h1':_0x459681(0x1ba),'p':'No\x20se\x20ejecuto\x20el\x20proceso\x20de\x20alta\x20de\x20pagos\x20en\x20portal,\x20para\x20la\x20compañia\x20'+database[_0x23e66c]+_0x459681(0x1a4)+_0x3a48cd['recordset'][_0x78250f][_0x459681(0x1d8)],'status':_0x22585b[_0x459681(0x1d0)],'message':_0x22585b[_0x459681(0x19e)],'position':_0x23e66c,'idCia':database[_0x23e66c]};await sendMail(_0x27163d)[_0x459681(0x1a3)](_0x246cba=>{console['log'](_0x246cba);});try{notifier[_0x459681(0x1da)]({'title':_0x459681(0x1c8),'message':_0x459681(0x1a6)+_0x22585b[_0x459681(0x19e)],'sound':!![],'wait':!![],'icon':process[_0x459681(0x1d6)]()+_0x459681(0x1d1)});}catch(_0x173b1a){console[_0x459681(0x198)](_0x173b1a),console[_0x459681(0x198)]('No\x20se\x20ejecuto\x20el\x20proceso:\x20'+_0x22585b[_0x459681(0x19e)]);}}}else console['log']('No\x20hay\x20facturas\x20pagadas\x20para\x20subir\x20a\x20portal');}else console[_0x459681(0x198)](_0x459681(0x1c3));}catch(_0x337d28){try{notifier['notify']({'title':'Error\x20al\x20ejecutar\x20el\x20proceso\x20de\x20alta\x20de\x20pagos\x20en\x20portal','message':_0x459681(0x1a6)+_0x337d28,'sound':!![],'wait':!![],'icon':process[_0x459681(0x1d6)]()+_0x459681(0x1d1)});}catch(_0x4e1f74){console[_0x459681(0x198)](_0x4e1f74);}}}module[_0x534a33(0x1bb)]={'uploadPayments':uploadPayments};
